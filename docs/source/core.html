<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*global MTVNPlayer, _, Url, _mtvnPlayerReady */
/* exported Core */
var Core = (function(core, $) {
    &quot;use strict&quot;;
    var baseURL = &quot;http://media.mtvnservices.com/&quot;,
        onPlayerCallbacks = [],
        // this is needed for the jQuery plugin only.
        getLegacyEventName = function(eventName) {
            if (eventName === &quot;uiStateChange&quot;) {
                return &quot;onUIStateChange&quot;;
            }
            return &quot;on&quot; + eventName.charAt(0).toUpperCase() + eventName.substr(1);
        };
    // exports
<span id='global-property-instances'>    /**
</span>     * @property instances
     * @ignore
     * An array of all the player instances.
     */
    core.instances = [];
<span id='global-property-baseURL'>    /**
</span>     * @property baseURL
     * @ignore
     * The base URL for the player request and for swf object.
     */
    core.baseURL = baseURL;
<span id='global-property-onPlayerCallbacks'>    /**
</span>     * @property onPlayerCallbacks
     * @ignore
     * These are fired when a player laods.
     */
    core.onPlayerCallbacks = onPlayerCallbacks;
    core.$ = $;

<span id='global-method-playerInit'>    /**
</span>     * Initialization that is common across player modules (meaning flash/html5).
     * This is here mostly to keep it out of the constructor.
     * @ignore
     */
    core.playerInit = function(player, playerModule) {
        // A list of event messages called before the player was ready
        var eventQueue = [];
        player.module = function() {
            var modules = {};
            return function(name) {
                if (modules[name]) {
                    return modules[name];
                }
                modules[name] = {};
                return modules[name];
            };
        }();
        player.destroy = function() {
            playerModule.destroy.apply(this, arguments);
        };
        player.message = function() {
            if (!this.ready) {
                eventQueue.push(arguments);
            } else {
                return playerModule.message.apply(this, arguments);
            }
        };
        player.one(&quot;ready&quot;, function(event) {
            var player = event.target,
                message = player.message;
            for (var i = 0, len = eventQueue.length; i &lt; len; i++) {
                message.apply(player, eventQueue[i]);
            }
        });
    };

<span id='global-property-isHTML5Player'>    /**
</span>     * @property isHTML5Player
     * @ignore
     * The logic that determines whether we're using flash or html
     */
    core.isHTML5Player = function(userAgent) {
        var n = userAgent ? userAgent.toLowerCase() : &quot;&quot;,
            checkSilk = function(n) {
                if (n.indexOf(&quot;silk&quot;) !== -1) {
                    var reg = /silk\/(\d)/ig,
                        result = parseInt(reg.exec(n)[1], 10);
                    return !isNaN(result) &amp;&amp; result &gt;= 2;
                }
                return false;
            },
            checkAndroid = function(n) {
                if (n.indexOf(&quot;android&quot;) !== -1) {
                    var reg = /android (\d)/ig,
                        result = parseInt(reg.exec(n)[1], 10);
                    return !isNaN(result) &amp;&amp; result &gt;= 4;
                }
                return false;
            },
            checkWiiu = function(n) {
                return n.indexOf(&quot;wiiu&quot;) !== -1;
            },
            checkPlayStation = function(n) {
                return n.indexOf(&quot;playstation 4&quot;) !== -1;
            };
        return n.indexOf(&quot;iphone&quot;) !== -1 || n.indexOf(&quot;ipad&quot;) !== -1 || checkSilk(n) || checkAndroid(n) || checkWiiu(n) || checkPlayStation(n);
    };

<span id='global-method-appendStyle'>    /**
</span>     * Utility function. Append css to the head.
     * @ignore
     */
    core.appendStyle = function(cssText) {
        var styles = document.createElement(&quot;style&quot;);
        styles.setAttribute(&quot;type&quot;, &quot;text/css&quot;);
        document.getElementsByTagName(&quot;head&quot;)[0].appendChild(styles);
        if (styles.styleSheet) {
            styles.styleSheet.cssText = cssText;
        } else {
            styles.appendChild(document.createTextNode(cssText));
        }
    };

<span id='global-method-getPath'>    /**
</span>     * @method getPath
     * @ignore
     * @param {Object} config
     * Check if there's a template URL (usually used for testing),
     * otherwise join the baseURL with the config.uri
     */
    core.getPath = function(config) {
        var path = baseURL + config.uri;
        if (config.templateURL) {
            path = config.templateURL.replace(&quot;{uri}&quot;, config.uri);
        }
        if (MTVNPlayer.isHTML5Player) {
            path = core.processQSParams(path, config);
        }
        return path;
    };
    core.processQSParams = function(path, config) {
        if (_.isObject(config.flashVars)) {
           path = Url.addQueryStringParam(path, &quot;flashVars&quot;, encodeURIComponent(JSON.stringify(config.flashVars)));
        }
        if (_.isObject(config.test)) {
           path = Url.addQueryStringParam(path, &quot;testConfig&quot;, encodeURIComponent(JSON.stringify(config.test)));
        }
        return path;
    };
<span id='global-method-processPerformance'>    /**
</span>     * @method processPerformance
     * @ignore
     * @param {MTVNPlayer.Player} player
     * @param {Object} performance data
     */
    core.processPerformance = function(player, data) {
        var startTime = player.config.performance.startTime,
            eventType = MTVNPlayer.Events.PERFORMANCE;
        for (var prop in data) {
            // adjust to the start time recorded by the embed api.
            data[prop] = data[prop] - startTime;
        }
        core.processEvent(player.events[eventType], {
            data: data,
            target: player,
            type: eventType
        });
    };
<span id='global-method-processEvent'>    /**
</span>     * @method processEvent
     * @ignore
     * @param {Object} {Array} event
     * @param {Object} data
     * Check if event is an Array, if so loop through, else just execute.
     */
    core.processEvent = function(event, data) {
        // trigger a jQuery event if there's an $el.
        if (data &amp;&amp; data.target &amp;&amp; data.target.$el) {
            data.target.$el.trigger(&quot;MTVNPlayer:&quot; + data.type, data);
            // legacy event names
            data.target.$el.trigger(&quot;MTVNPlayer:&quot; + getLegacyEventName(data.type), data);
        }
        if (!event) {
            return;
        }
        if (event instanceof Array) { // this will always be same-frame. (instanceof fails cross-frame.)
            // clone array
            event = event.slice();
            // fire in order
            for (var i = 0, len = event.length; i &lt; len; i++) {
                event[i](data);
            }
        } else {
            event(data);
        }
    };
<span id='global-method-getPlayerInstance'>    /**
</span>     * @method getPlayerInstance
     * @ignore
     * @param {ContentWindow} source
     * @returns {MTVNPlayer.Player} A player instance
     */
    core.getPlayerInstance = function(source) {
        var i, player = null,
            numberOfInstances = core.instances.length,
            currentInstance;
        for (i = numberOfInstances; i--;) {
            currentInstance = core.instances[i];
            if (currentInstance.source === source) {
                // compare source (contentWindow) to get events object from the right player. (if flash, source is the embed id)
                player = currentInstance.player;
                break;
            }
        }
        return player;
    };
<span id='global-method-executeCallbacks'>    /**
</span>     * @method executeCallbacks
     * @ignore
     * @param {MTVNPlayer.Player} player
     * Fires callbacks registered with MTVNPlayer.onPlayer
     */
    core.executeCallbacks = function(player) {
        var cbs = onPlayerCallbacks.concat(_mtvnPlayerReady).slice(),
            i = 0,
            len = cbs.length;
        for (i; i &lt; len; i++) {
            cbs[i](player);
        }
    };
    return core;
})(window.MTVNPlayer.module(&quot;core&quot;), window.jQuery || window.Zepto);</pre>
</body>
</html>
